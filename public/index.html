<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hotel-Dashboard Â· Server-Ãœbersicht</title>
  <meta name="color-scheme" content="light dark">
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#0b0f16; --fg:#e9eef7; --muted:#9aa6b2; --card:#121826; --line:#2a3243;
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --info:#38bdf8; --chip:#1f2937; --radius:14px;
      --overlay:linear-gradient(to bottom, rgba(0,0,0,.32), rgba(0,0,0,.18));
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --fg:#111827; --muted:#6b7280; --card:#ffffff; --line:#e5e7eb; --chip:#f3f4f6; --overlay:linear-gradient(to bottom, rgba(255,255,255,.18), rgba(255,255,255,.06)); }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background-image: var(--overlay), url("/hotel-dashboard-bg.jpg");
      background-size: cover; background-attachment: fixed; background-position: center;
    }
    .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr auto;gap:16px;padding:clamp(14px,2.6vw,24px)}
    header,footer{display:flex;align-items:center;gap:12px}
    header{justify-content:space-between;position:sticky;top:0;background:linear-gradient(to bottom,var(--bg) 70%,transparent);z-index:5;padding-bottom:6px}
    .stamp{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button,.btn{background:transparent;border:1px solid var(--line);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    button:hover,.btn:hover{background:rgba(255,255,255,.06)}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(340px,1fr))}
    .x2{grid-column:span 2}
    .x3{grid-column:span 3}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;display:grid;gap:10px}
    .card h3{margin:0 0 6px;font-size:16px;display:flex;align-items:center;gap:8px}
    .row{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px dashed var(--line);border-radius:10px;background:rgba(255,255,255,.02);gap:12px}
    .row span.small{color:var(--muted);font-size:12.5px}
    .kv{display:flex;align-items:center;justify-content:space-between;border-bottom:1px dashed var(--line);padding:6px 0;font-size:13.5px;gap:8px}
    .kv:last-child{border-bottom:0}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:var(--chip);padding:2px 6px;border-radius:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:3px 10px;font-weight:700;border:1px solid var(--line);white-space:nowrap}
    .ok{color:#fff;background:rgba(22,163,74,.25);border-color:rgba(22,163,74,.5)}
    .warn{color:#000;background:rgba(245,158,11,.35);border-color:rgba(245,158,11,.6)}
    .err{ color:#fff;background:rgba(239,68,68,.35); border-color:rgba(239,68,68,.6)}
    .info{color:#fff;background:rgba(56,189,248,.25);border-color:rgba(56,189,248,.5)}
    .small{color:var(--muted);font-size:12.5px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    details{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:10px;padding:8px}
    details>summary{cursor:pointer;font-weight:600;margin:4px 0}
    .list{display:grid;gap:6px}
    .errtext{white-space:pre-wrap;color:#fecaca;font-size:12.5px}
    .muted{color:var(--muted)}
    .paths table{width:100%;border-collapse:collapse;font-size:13.5px}
    .paths th,.paths td{padding:6px 8px;text-align:left}
    .paths th{background:var(--line);color:var(--fg)}
    .paths tr:nth-child(even){background:rgba(255,255,255,.04)}
    .btn-row{display:flex;flex-wrap:wrap;gap:8px}
    .log{background:rgba(0,0,0,.35);border:1px solid var(--line);border-radius:10px;padding:10px;white-space:pre-wrap;font-size:12.5px;max-height:240px;overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h2 style="margin:0">Hotel-Dashboard Â· Server-Ãœbersicht</h2>
        <div class="stamp">
          Host: <code id="host">â€“</code> Â· Origin: <code id="origin">â€“</code> Â·
          <span id="redir-note" class="small">/ Redirect-Status: â€“</span> Â·
          <span id="now">â€“</span> Â· Auto-Refresh <code id="refresh-iv">5s</code>
        </div>
      </div>
      <div class="actions">
        <a class="btn" href="/dashboard">ğŸ¨ Dashboard</a>
        <form method="POST" action="/logout" style="margin:0"><button class="btn" type="submit">ğŸ”’ Logout</button></form>
        <button id="btn-refresh">Jetzt aktualisieren</button>
        <button id="btn-fast">Schneller (2s)</button>
        <button id="btn-slow">Langsamer (10s)</button>
        <button id="btn-pause">â¸ï¸ Pause</button>
        <!-- Direktzugriff Neustart -->
        <button id="btn-restart-hotel">ğŸ” Hotel neu starten</button>
      </div>
    </header>

    <main class="grid">
      <!-- HTTP-Basics -->
      <section class="card">
        <h3>HTTP-Basics</h3>
        <div class="row"><span>Health <span class="small">GET /health</span></span><span id="b-health" class="badge info">prÃ¼feâ€¦</span></div>
        <div class="row"><span>Root <span class="small">GET / (REDIR?)</span></span><span id="b-root" class="badge info">prÃ¼feâ€¦</span></div>
        <div class="row"><span>Login-Seite <span class="small">GET /login</span></span><span id="b-login" class="badge info">prÃ¼feâ€¦</span></div>
        <div class="row"><span>Reset-Seite <span class="small">GET /reset</span></span><span id="b-reset" class="badge info">prÃ¼feâ€¦</span></div>
        <div class="row"><span>Reset Validate <span class="small">GET /reset/validate?email=x&token=y</span></span><span id="b-validate" class="badge info">prÃ¼feâ€¦</span></div>
        <div class="row"><span>Session-API <span class="small">GET /session/remaining</span></span><span id="b-session" class="badge info">prÃ¼feâ€¦</span></div>
        <details><summary>Details & Latenzen</summary><div id="http-details" class="list mono small">â€“</div></details>
      </section>

      <!-- Assets -->
      <section class="card">
        <h3>Assets</h3>
        <div class="row"><span>Logo <span class="small">HEAD /HD-Logo.png</span></span><span id="b-logo" class="badge info">prÃ¼feâ€¦</span></div>
        <div class="row"><span>Wordmark <span class="small">HEAD /Hotel-Dashboard-Schriftzug.png</span></span><span id="b-word" class="badge info">prÃ¼feâ€¦</span></div>
        <div class="row"><span>Background <span class="small">HEAD /hotel-dashboard-bg.jpg</span></span><span id="b-bg" class="badge info">prÃ¼feâ€¦</span></div>
        <details><summary>Fehlertexte</summary><div id="asset-errors" class="errtext">â€“</div></details>
      </section>

      <!-- Server / OS / Node / Git -->
      <section class="card">
        <h3>Server-Status</h3>
        <div class="kv"><span>Port</span><code id="s-port">â€“</code></div>
        <div class="kv"><span>PID</span><code id="s-pid">â€“</code></div>
        <div class="kv"><span>Uptime</span><code id="s-uptime">â€“</code></div>
        <div class="kv"><span>Node</span><code id="s-node">â€“</code></div>
        <div class="kv"><span>CPU-Load (1/5/15)</span><code id="s-load">â€“</code></div>
        <div class="kv"><span>RAM used</span><code id="s-mem">â€“</code></div>
        <div class="kv"><span>Benutzer</span><code id="s-user">â€“</code></div>
        <div class="kv"><span>Arbeitsverzeichnis</span><code id="s-cwd">â€“</code></div>
        <div id="status-note" class="small muted">Nutzt /admin/status, falls vorhanden.</div>
      </section>

      <section class="card">
        <h3>Git</h3>
        <div class="kv"><span>Branch</span><code id="g-branch">â€“</code></div>
        <div class="kv"><span>Letzter Commit</span><code id="g-last">â€“</code></div>
        <details><summary>Repository-Infos</summary><div class="list mono small" id="g-extra">â€“</div></details>
        <div class="btn-row">
          <a class="btn" href="/admin/status">ğŸ“Š /admin/status</a>
          <a class="btn" href="/git" target="_self">ğŸ” /git</a>
        </div>
      </section>

      <!-- Dienste / Ports / Proxy -->
      <section class="card x2">
        <h3>Dienste Â· Ports Â· Proxy</h3>
        <div class="list" id="svc">Ladeâ€¦</div>
        <details style="margin-top:8px"><summary>Offene Ports (Ausschnitt)</summary><div class="list mono small" id="ports">â€“</div></details>
        <details style="margin-top:8px"><summary>Proxy-Reachability (Host-Header lokal)</summary><div class="list mono small" id="proxy">â€“</div></details>
      </section>

      <!-- Express-Routen -->
      <section class="card x2">
        <h3>Express-Routen</h3>
        <div class="list mono small" id="routes">â€“</div>
        <div class="btn-row">
          <a class="btn" href="/login">ğŸ”‘ Login</a>
          <a class="btn" href="/reset">ğŸ›  Reset</a>
          <a class="btn" href="/dashboard">ğŸ¨ Dashboard</a>
          <a class="btn" href="/">ğŸ  Root</a>
        </div>
      </section>

      <!-- Pfad-Status -->
      <section class="card x2 paths">
        <h3>Pfad-Status</h3>
        <table id="pathTable"><thead><tr><th>Pfad</th><th>Status</th></tr></thead><tbody></tbody></table>
      </section>

      <!-- Admin-Aktionen -->
      <section class="card x2">
        <h3>Admin-Aktionen</h3>
        <div class="row">
          <span>Hotel-App neu starten <span class="small">/usr/local/bin/restart-hotel.sh</span></span>
          <span><button id="btn-run-restart" class="btn">ğŸ” AusfÃ¼hren</button></span>
        </div>
        <div class="row">
          <span>Nginx neu starten <span class="small">POST /admin/restart {"service":"nginx"}</span></span>
          <span><button id="btn-restart-nginx" class="btn">ğŸ” Nginx</button></span>
        </div>
        <div class="row">
          <span>Apache neu starten <span class="small">POST /admin/restart {"service":"apache2"}</span></span>
          <span><button id="btn-restart-apache" class="btn">ğŸ” Apache</button></span>
        </div>
        <details open><summary>Ausgabe</summary><div id="admin-log" class="log">â€“</div></details>
        <div class="small muted">Hinweis: Diese Buttons erwarten serverseitige Routen/Rechte (CSRF/Auth). Hotel-App nutzt das eingerichtete Root-Skript. :contentReference[oaicite:2]{index=2}</div>
      </section>
    </main>

    <footer class="small">
      <span class="badge ok">OK</span> grÃ¼n Â· <span class="badge warn">WARN</span> gelb Â· <span class="badge err">FEHLER</span> rot
    </footer>
  </div>

  <script>
    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const set = (sel, txt) => { const el=$(sel); if(el) el.textContent=txt; };
    const badge = (sel, ok, warn=false, txt) => { const el=$(sel); if(!el) return;
      el.className='badge '+(ok?'ok':(warn?'warn':'err')); el.textContent=txt||(ok?'OK':(warn?'WARN':'FEHLER')); };
    const fmtMs = ms => (ms<1000? `${ms.toFixed(0)}ms` : `${(ms/1000).toFixed(2)}s`);
    const head = async (url) => { const t0=performance.now();
      try{ const r=await fetch(url,{method:'HEAD',cache:'no-store'}); return {ok:r.ok,st:r.status,ms:performance.now()-t0}; }
      catch(e){ return {ok:false,st:0,ms:performance.now()-t0}; } };
    const get = async (url,opts={}) => { const t0=performance.now();
      try{ const r=await fetch(url,Object.assign({cache:'no-store'},opts)); return {ok:r.ok,st:r.status,ms:performance.now()-t0,r,type:r.type}; }
      catch(e){ return {ok:false,st:0,ms:performance.now()-t0,type:'error'}; } };
    const cookie = (name)=>document.cookie.split('; ').find(x=>x.startsWith(name+'='))?.split('=')[1];
    const postJSON = async (url, body={})=>{
      const headers = {'Content-Type':'application/json'};
      const csrf = cookie('csrfToken'); if(csrf) headers['X-CSRF-Token']=csrf;
      const r = await fetch(url,{method:'POST',headers,body:JSON.stringify(body),cache:'no-store'});
      const text = await r.text(); // akzeptiert JSON oder Text
      let j=null; try{ j=JSON.parse(text); }catch{}
      return {ok:r.ok, st:r.status, text, json:j};
    };

    // ===== Refresh-Interval / Scroll-StabilitÃ¤t =====
    let interval=5000,timer=null,paused=false;
    function schedule(){ clearInterval(timer); if(!paused) timer=setInterval(refresh,interval); set('#refresh-iv',(interval/1000)+'s'); }
    function setPause(p){ paused=p; $('#btn-pause').textContent=paused?'â–¶ï¸ Fortsetzen':'â¸ï¸ Pause'; schedule(); }
    $('#btn-pause').addEventListener('click',()=>setPause(!paused));
    $('#btn-refresh').addEventListener('click',refresh);
    $('#btn-fast').addEventListener('click',()=>{interval=2000;schedule();refresh();});
    $('#btn-slow').addEventListener('click',()=>{interval=10000;schedule();});

    async function refresh(){ const y=window.scrollY; await run(); window.scrollTo({top:y,left:0,behavior:'instant'}); }

    // ===== Checks =====
    async function checkRootRedirect(){
      const r=await get('/',{redirect:'manual'});
      if(r.type==='opaqueredirect'||(r.st>=300&&r.st<400)){ badge('#b-root',true,false,'REDIR'); set('#redir-note','/ Redirect-Status: REDIR'); }
      else{ badge('#b-root',r.ok,false,r.ok?'OK':'FEHLER'); set('#redir-note','/ Redirect-Status: '+(r.ok?'OK':'FEHLER')); }
      return r;
    }

    async function updateHTTP(){
      const rows=[];
      let r=await get('/health'); badge('#b-health',r.ok); rows.push(`GET /health â†’ ${r.st} Â· ${fmtMs(r.ms)}`);
      r=await checkRootRedirect(); rows.push(`GET / â†’ ${r.st||'(opaqueredirect)'} Â· ${fmtMs(r.ms)} Â· type=${r.type}`);
      r=await get('/login'); badge('#b-login',r.ok); rows.push(`GET /login â†’ ${r.st} Â· ${fmtMs(r.ms)}`);
      r=await get('/reset'); badge('#b-reset', r.ok || r.st===200 || r.st===204, r.st===404); rows.push(`GET /reset â†’ ${r.st} Â· ${fmtMs(r.ms)}`);
      r=await get('/reset/validate?email=a@b&token=123'); badge('#b-validate',[200,400,401,403,404,422].includes(r.st), r.st===404); rows.push(`GET /reset/validate?... â†’ ${r.st} Â· ${fmtMs(r.ms)}`);
      r=await get('/session/remaining'); badge('#b-session', r.ok || [200,401,403].includes(r.st)); rows.push(`GET /session/remaining â†’ ${r.st} Â· ${fmtMs(r.ms)}`);
      $('#http-details').textContent=rows.join('\n');
    }

    async function updateAssets(){
      const errs=[];
      let a=await head('/HD-Logo.png'); badge('#b-logo',a.ok); if(!a.ok) errs.push(`HD-Logo.png â†’ ${a.st} Â· ${fmtMs(a.ms)}`);
      a=await head('/Hotel-Dashboard-Schriftzug.png'); badge('#b-word',a.ok); if(!a.ok) errs.push(`Hotel-Dashboard-Schriftzug.png â†’ ${a.st} Â· ${fmtMs(a.ms)}`);
      a=await head('/hotel-dashboard-bg.jpg'); badge('#b-bg',a.ok); if(!a.ok) errs.push(`hotel-dashboard-bg.jpg â†’ ${a.st} Â· ${fmtMs(a.ms)}`);
      $('#asset-errors').textContent=errs.length?errs.join('\n'):'keine';
    }

    async function updateAdminStatus(){
      try{
        const r=await get('/admin/status'); if(!r.ok) throw 0; const j=await r.r.json();
        // Node/OS
        set('#s-port',j?.node?.port??'â€“'); set('#s-pid',j?.node?.pid??'â€“'); set('#s-uptime',j?.node?.uptime??'â€“');
        set('#s-node',j?.node?.version??'â€“'); set('#s-user',j?.os?.user??'â€“'); set('#s-cwd',j?.os?.cwd??'â€“');
        set('#s-load',Array.isArray(j?.os?.load)?j.os.load.join(' / '):'â€“'); set('#s-mem',j?.os?.mem??'â€“');
        // Git
        set('#g-branch',j?.git?.branch??'â€“'); set('#g-last',j?.git?.last??'â€“'); $('#g-extra').textContent=(j?.git?.info||['â€“']).join('\n');
        // Dienste
        const box=$('#svc'); box.innerHTML=''; (j?.services||[]).forEach(o=>{ const div=document.createElement('div'); div.className='row';
          const left=document.createElement('span'); left.textContent=`${o.name}${o.detail?' Â· '+o.detail:''}`;
          const right=document.createElement('span'); right.className='badge '+(o.ok?'ok':(o.warn?'warn':'err')); right.textContent=o.ok?'OK':(o.warn?'WARN':'FEHLER');
          div.append(left,right); box.append(div); });
        // Netz/Proxy/Routes
        $('#ports').textContent=(j?.net?.ports||['â€“']).join('\n'); $('#proxy').textContent=(j?.proxy?.checks||['â€“']).join('\n'); $('#routes').textContent=(j?.routes||['â€“']).join('\n');
      }catch(e){
        // Fallback, wenn /admin/status fehlt
        set('#s-port','â€“'); set('#s-pid','â€“'); set('#s-uptime','â€“'); set('#s-node','â€“'); set('#s-user','â€“'); set('#s-cwd','â€“'); set('#s-load','â€“'); set('#s-mem','â€“');
        set('#g-branch','â€“'); set('#g-last','â€“'); $('#g-extra').textContent='â€“'; $('#svc').textContent='(kein /admin/status)'; $('#ports').textContent='â€“'; $('#proxy').textContent='â€“'; $('#routes').textContent='â€“';
      }
    }

    async function updatePaths(){
      const paths=["/health","/","/login","/reset","/reset/validate?email=x&token=y","/reset/confirm","/index","/dashboard"];
      const tbody=document.querySelector("#pathTable tbody");
      for(const p of paths){
        let st=0, ok=false;
        try{ const r=await fetch(p,{method:"GET",cache:"no-store",redirect:"manual"}); st=r.status||0; ok=st!==0 && st!==404 && st<500; }
        catch{ st=0; ok=false; }
        let tr=[...tbody.querySelectorAll('tr')].find(x=>x.firstChild.textContent===p);
        const cell=`<td class="${ok?'ok':'err'}">${ok?'âœ” OK':'âœ˜ Fehler'} <span class="small mono">(${st||'â€“'})</span></td>`;
        if(!tr){ tr=document.createElement('tr'); tr.innerHTML=`<td>${p}</td>${cell}`; tbody.appendChild(tr); }
        else{ tr.lastChild.outerHTML=cell; }
      }
    }

    // ===== Admin Buttons =====
    function logAppend(msg){ const el=$('#admin-log'); el.textContent=(el.textContent==='â€“'?'':el.textContent+'\n')+msg; el.scrollTop=el.scrollHeight; }

    async function runRestartHotel(){
      logAppend('> Starte: /usr/local/bin/restart-hotel.sh â€¦');
      try{
        const r = await postJSON('/admin/restart', {script:'hotel'});
        if(r.ok){
          logAppend('âœ… OK '+r.st+'\n'+(r.json?JSON.stringify(r.json,null,2):r.text));
        }else{
          logAppend('âŒ FEHLER '+r.st+'\n'+(r.text||''));
        }
      }catch(e){ logAppend('âŒ Ausnahme: '+(e&&e.message||e)); }
    }

    async function runRestartService(svc){
      logAppend(`> Starte: service=${svc} â€¦`);
      try{
        const r = await postJSON('/admin/restart', {service:svc});
        if(r.ok){
          logAppend('âœ… OK '+r.st+'\n'+(r.json?JSON.stringify(r.json,null,2):r.text));
        }else{
          logAppend('âŒ FEHLER '+r.st+'\n'+(r.text||''));
        }
      }catch(e){ logAppend('âŒ Ausnahme: '+(e&&e.message||e)); }
    }

    // ===== Run All =====
    async function run(){
      set('#host',location.host); set('#origin',location.origin); set('#now',new Date().toLocaleString());
      await updateHTTP(); await updateAssets(); await updateAdminStatus(); await updatePaths();
    }

    // Init
    schedule(); run();

    // Button Handlers
    $('#btn-restart-hotel').addEventListener('click', runRestartHotel);
    $('#btn-run-restart').addEventListener('click', runRestartHotel);
    $('#btn-restart-nginx').addEventListener('click', ()=>runRestartService('nginx'));
    $('#btn-restart-apache').addEventListener('click', ()=>runRestartService('apache2'));
  </script>
</body>
</html>
