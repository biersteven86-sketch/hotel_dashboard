<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Passwort · Hotel-Dashboard</title>
  <meta name="color-scheme" content="light dark">

  <!-- Assets (gleich wie login.html) -->
  <link rel="preload" as="image" href="/hotel-dashboard-bg.jpg">
  <link rel="preload" as="image" href="/HD-Logo.png">
  <link rel="preload" as="image" href="/Hotel-Dashboard-Schriftzug.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --page:#06080c; --text:#eef2f8; --muted:#cfd6de;
      --accent:#b71c1c; --accent-2:#7f0000; --accent-link:#fff;
      --panel-r:103; --panel-g:103; --panel-b:103; --panel-alpha:.50; --panel-border:rgba(255,255,255,.10);
      --card-w:520px; --radius:22px;
      --hd:116px; --word-gap:-24px; --title-w:86%; --title-gap:-6px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-size:16px;line-height:1.45;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      color:var(--text);background:var(--page) url("/hotel-dashboard-bg.jpg") center/cover fixed no-repeat;
    }
    .wrap{min-height:100%;display:grid;place-items:center;padding:clamp(18px,4vw,60px)}
    .card{
      position:relative;width:min(var(--card-w),94vw);border-radius:var(--radius);
      background:rgba(var(--panel-r),var(--panel-g),var(--panel-b),var(--panel-alpha));
      backdrop-filter:blur(8px) saturate(120%);-webkit-backdrop-filter:blur(8px) saturate(120%);
      border:1px solid var(--panel-border);
      box-shadow:0 26px 70px rgba(0,0,0,.68),0 1px 0 rgba(255,255,255,.05) inset;
      padding:clamp(18px,2.2vw,24px);padding-top:calc(var(--hd)*.78 + var(--title-gap) + 14px);padding-bottom:8px;overflow:visible;
    }
    .brand-stack{position:absolute;left:50%;top:0;transform:translate(-50%,-48%);display:grid;place-items:center;pointer-events:none;z-index:5;width:min(32vw,520px)}
    .brand-stack .hd{width:var(--hd);height:var(--hd);object-fit:contain;display:block;filter:drop-shadow(0 22px 38px rgba(0,0,0,.55)) drop-shadow(0 1px 0 rgba(255,255,255,.08))}
    .brand-stack .wordmark{margin-top:var(--word-gap);width:var(--title-w);height:auto;display:block;filter:drop-shadow(0 1px 0 rgba(255,255,255,.10)) drop-shadow(0 16px 26px rgba(0,0,0,.50))}
    .title-spacer{height:var(--title-gap)} h2{margin:0 0 8px}
    p{margin:0 0 10px;color:var(--muted)}
    .field{display:grid;grid-template-columns:1fr auto;align-items:center;min-height:48px;padding:0 12px;border-radius:14px;background:transparent;border:1.2px solid rgba(255,255,255,.25);box-shadow:inset 0 1px 0 rgba(255,255,255,.06),0 10px 26px rgba(0,0,0,.40)}
    .field:focus-within{border-color:rgba(255,255,255,.42);box-shadow:0 0 0 3px rgba(224,40,36,.18),0 14px 34px rgba(0,0,0,.55)}
    .field input{background:transparent;border:0;outline:0;color:#fff;font-size:16px;padding:10px 8px;width:100%;caret-color:#fff}
    .row{display:grid;gap:10px} label{display:block;font-size:15px;color:#fff;margin:0 0 4px}
    .submit{margin-top:6px;border:0;border-radius:14px;padding:12px 26px;font-weight:900;font-size:16px;color:#fff;cursor:pointer;background:linear-gradient(180deg,var(--accent),var(--accent-2))}
    .submit:disabled{opacity:.6;cursor:not-allowed} .link{color:var(--accent-link);text-decoration:none}
    .error{display:none;background:rgba(224,39,36,.12);border:1px solid rgba(224,39,36,.45);color:#ffd6d6;padding:10px 12px;border-radius:12px;font-size:13px}
    .ok{display:none;background:rgba(11,156,49,.14);border:1px solid rgba(11,156,49,.45);color:#d7ffd7;padding:10px 12px;border-radius:12px;font-size:13px}
    .foot{margin-top:15px;padding:12px 6px 6px;border-top:1px solid rgba(255,255,255,.10);text-align:center;color:#e0e5ec;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="group" aria-labelledby="hd-title">
      <div class="brand-stack" aria-hidden="true">
        <img class="hd" src="/HD-Logo.png" alt="HD">
        <img class="wordmark" src="/Hotel-Dashboard-Schriftzug.png" alt="Hotel-Dashboard" id="hd-title">
      </div>

      <div class="title-spacer" aria-hidden="true"></div>

      <div id="view-email">
        <h2>Passwort zurücksetzen</h2>
        <p>Gib deine E-Mail ein. Wir schicken dir einen Link und einen Code.</p>
        <div class="error" id="err-email"></div>
        <div class="ok" id="ok-email"></div>
        <form id="form-email" class="row" novalidate>
          <label for="email">E-Mail</label>
          <div class="field"><input id="email" name="email" type="email" autocomplete="email" placeholder="name@example.com" required></div>
          <button class="submit" id="btn-send" type="submit">Link zusenden</button>
          <small>Schon einen Code? <a class="link" href="#" id="goto-token">Zur Code-Eingabe wechseln</a></small>
        </form>
      </div>

      <div id="view-token" style="display:none">
        <h2>Code prüfen & neues Passwort</h2>
        <p>Wir haben dir einen Link und Code geschickt. Trage beides hier ein.</p>
        <div class="error" id="err-token"></div>
        <div class="ok" id="ok-token"></div>
        <form id="form-token" class="row" novalidate>
          <label for="email2">E-Mail</label>
          <div class="field"><input id="email2" name="email" type="email" required></div>

          <label for="token">Code</label>
          <div class="field"><input id="token" name="token" type="text" minlength="6" maxlength="16" required></div>

          <label for="firstname">Vorname</label>
          <div class="field"><input id="firstname" name="firstname" type="text" required></div>

          <label for="lastname">Nachname</label>
          <div class="field"><input id="lastname" name="lastname" type="text" required></div>

          <label for="password">Neues Passwort</label>
          <div class="field"><input id="password" name="password" type="password" placeholder="mind. 10 Zeichen" required></div>
          <label for="password2">Passwort (Wiederholen)</label>
          <div class="field"><input id="password2" type="password" required></div>

          <button class="submit" id="btn-confirm" type="submit">Passwort setzen</button>
          <small>Fertig? <a class="link" href="/login">Jetzt anmelden</a></small>
        </form>
      </div>

      <div class="foot">
        <small>© <span id="y"></span> Hotel-Dashboard · Powered by MY HOME HOTEL LAMM ROTTWEIL GMBH</small>
      </div>
    </div>
  </div>

  <script>
  document.getElementById('y').textContent=new Date().getFullYear();

  const qs = new URLSearchParams(location.search);
  const hasDeepLink = qs.has('token') && qs.has('email');

  const vEmail  = document.getElementById('view-email');
  const vToken  = document.getElementById('view-token');
  const errE    = document.getElementById('err-email');
  const okE     = document.getElementById('ok-email');
  const errT    = document.getElementById('err-token');
  const okT     = document.getElementById('ok-token');

  const email   = document.getElementById('email');
  const email2  = document.getElementById('email2');
  const token   = document.getElementById('token');
  const fn      = document.getElementById('firstname');
  const ln      = document.getElementById('lastname');
  const pw      = document.getElementById('password');
  const pw2     = document.getElementById('password2');

  function show(el, on){ el.style.display = on ? '' : 'none'; }
  function msg(el, text){ el.textContent = text; el.style.display = text ? 'block':'none'; }

  // Startansicht: Wenn Link/Token in URL -> direkt Token-View
  if (hasDeepLink) {
    email2.value = qs.get('email') || '';
    token.value  = qs.get('token') || '';
    show(vEmail,false); show(vToken,true);
  } else {
    show(vEmail,true); show(vToken,false);
  }

  // Wechsel manuell
  document.getElementById('goto-token').addEventListener('click', (e)=>{
    e.preventDefault();
    email2.value = email.value || '';
    show(vEmail,false); show(vToken,true);
  });

  // E-Mail absenden -> /reset (Server sendet Mail & speichert Token)
  document.getElementById('form-email').addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg(errE,''); msg(okE,'');
    const val = (email.value||'').trim();
    if(!val){ msg(errE,'Bitte E-Mail eintragen'); return; }
    try{
      const res = await fetch('/reset', {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ email: val })
      });
      if(!res.ok){
        const t = await res.text();
        msg(errE, t || 'Senden fehlgeschlagen');
        return;
      }
      msg(okE,'Reset-Mail wurde gesendet. Bitte Postfach prüfen.');
      // Neu: sofort in Token-Ansicht wechseln, E-Mail übernehmen – kein Countdown
      email2.value = val;
      show(vEmail,false); show(vToken,true);
    }catch(err){
      msg(errE,'Netzwerkfehler – bitte später erneut versuchen.');
    }
  });

  // Policy-Check clientseitig
  function strong(p){
    return p.length>=10 && /[A-Z]/.test(p) && /[a-z]/.test(p) && (/\d/.test(p) || /[^A-Za-z0-9]/.test(p));
  }

  // Passwort setzen -> /reset/confirm
  document.getElementById('form-token').addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg(errT,''); msg(okT,'');
    const em = (email2.value||'').trim().toLowerCase();
    const tk = (token.value||'').trim();
    const a  = (fn.value||'').trim();
    const b  = (ln.value||'').trim();
    const p1 = pw.value||'', p2 = pw2.value||'';

    if(!(em && tk && a && b && p1 && p2)){ msg(errT,'Bitte alle Felder ausfüllen.'); return; }
    if(p1!==p2){ msg(errT,'Die beiden Passwörter stimmen nicht überein.'); return; }
    if(!strong(p1)){ msg(errT,'Passwort zu schwach (mind. 10 Zeichen, Groß/Klein + Zahl/Sonderzeichen).'); return; }

    try{
      const res = await fetch('/reset/confirm', {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          email: em, token: tk, firstname: a, lastname: b, password: p1
        })
      });
      const txt = await res.text();
      if(!res.ok){
        msg(errT, txt || 'Fehler beim Setzen des Passworts');
        return;
      }
      // Erfolg: Meldung anzeigen, KEIN Auto-Redirect – Button „Jetzt anmelden“ ist sichtbar
      msg(okT, 'Passwort gesetzt. Du kannst dich jetzt anmelden.');
    }catch(err){
      msg(errT,'Netzwerkfehler – bitte später erneut versuchen.');
    }
  });
  </script>
</body>
</html>
