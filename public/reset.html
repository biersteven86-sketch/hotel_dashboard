<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Passwort zurücksetzen · Hotel-Dashboard</title>
  <meta name="color-scheme" content="light dark">
  <link rel="preload" as="image" href="/Hotel-Dashboard-hintergrund.jpg">
  <link rel="preload" as="image" href="/HD-Logo.png">
  <link rel="preload" as="image" href="/Hotel-Dashboard-Schriftzug.png">
  <style>
    :root { --panel-bg: rgba(255,255,255,0.9); --panel-fg:#111; --muted:#666; --accent:#0a7cff; }
    @media (prefers-color-scheme: dark) {
      :root { --panel-bg: rgba(24,24,24,0.9); --panel-fg:#f3f3f3; --muted:#aaa; }
    }
    html,body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body {
      background: #000 url('/Hotel-Dashboard-hintergrund.jpg') center/cover no-repeat fixed;
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card {
      width:min(720px, 96vw); background:var(--panel-bg); color:var(--panel-fg);
      border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.35); overflow:hidden;
      backdrop-filter: blur(6px);
    }
    .head { text-align:center; padding:28px 24px 8px; }
    .brand { display:flex; flex-direction:column; align-items:center; gap:10px; }
    .brand img.logo { width:72px; height:72px; object-fit:contain; }
    .brand img.wordmark { height:26px; object-fit:contain; }

    .tabs { display:flex; gap:8px; padding:0 22px; }
    .tab {
      flex: 1; text-align:center; padding:10px 12px; border-bottom:2px solid transparent;
      font-weight:600; cursor:pointer; color:var(--muted);
    }
    .tab.active { color:var(--panel-fg); border-color:var(--accent); }

    .body { padding:22px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:18px; }
    @media (max-width: 760px) { .grid { grid-template-columns:1fr; } }

    label { font-size:14px; color:var(--muted); display:block; margin:4px 0; }
    input {
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #ccc;
      background:#fff; color:#111; outline:none;
    }
    @media (prefers-color-scheme: dark) {
      input { background:#181818; color:#eee; border-color:#3a3a3a; }
    }
    .btn {
      cursor:pointer; width:100%; padding:12px 14px; border:none; border-radius:12px;
      background:var(--accent); color:#fff; font-weight:600; font-size:16px;
    }
    .msg { font-size:14px; padding:10px 12px; border-radius:10px; display:none; margin-bottom:12px; }
    .msg.ok { background:rgba(16,185,129,0.15); color:#10b981; display:block; }
    .msg.err{ background:rgba(239,68,68,0.15);  color:#ef4444; display:block; }
    .muted { color:var(--muted); font-size:14px; }
    .row { display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .hide{ display:none !important; }
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="title">
    <header class="head">
      <div class="brand">
        <img class="logo" src="/HD-Logo.png" alt="Hotel-Dashboard Logo" />
        <img class="wordmark" src="/Hotel-Dashboard-Schriftzug.png" alt="Hotel-Dashboard" />
      </div>
    </header>

    <nav class="tabs" aria-label="Ansichten">
      <div id="tabRequest" class="tab">Link zusenden</div>
      <div id="tabConfirm" class="tab">Passwort setzen</div>
    </nav>

    <section class="body">
      <div id="msg" class="msg" role="status" aria-live="polite"></div>

      <!-- Ansicht A: E-Mail zum Zusenden -->
      <form id="formRequest" method="post" action="/reset" novalidate>
        <label for="req_email">E-Mail</label>
        <input id="req_email" name="email" type="email" required placeholder="dein.name@hotel.de" autocomplete="email" />
        <button class="btn" type="submit" style="margin-top:12px;">Link zusenden</button>
        <p class="muted" style="margin-top:10px;">Du erhältst eine E-Mail mit einem Token zum Zurücksetzen.</p>
      </form>

      <!-- Ansicht B: Passwort setzen -->
      <form id="formConfirm" class="hide" method="post" action="/reset/confirm" novalidate>
        <div class="grid">
          <div>
            <label for="conf_email">E-Mail</label>
            <input id="conf_email" name="email" type="email" required placeholder="dein.name@hotel.de" autocomplete="email" />
          </div>
          <div>
            <label for="conf_token">Token</label>
            <input id="conf_token" name="token" type="text" required placeholder="abcdef123456" autocomplete="one-time-code" />
          </div>
          <div>
            <label for="conf_first">Vorname</label>
            <input id="conf_first" name="firstName" type="text" required placeholder="Vorname" />
          </div>
          <div>
            <label for="conf_last">Nachname</label>
            <input id="conf_last" name="lastName" type="text" required placeholder="Nachname" />
          </div>
          <div>
            <label for="conf_pass">Neues Passwort</label>
            <input id="conf_pass" name="password" type="password" required placeholder="••••••••" autocomplete="new-password" />
          </div>
          <div>
            <label for="conf_pass2">Passwort wiederholen</label>
            <input id="conf_pass2" name="password2" type="password" required placeholder="••••••••" autocomplete="new-password" />
          </div>
        </div>
        <button class="btn" type="submit" style="margin-top:12px;">Passwort setzen</button>
        <div class="row" style="margin-top:10px;">
          <span class="muted">Fertig?</span><a class="muted" style="text-decoration:none;" href="/login">Zur Anmeldung</a>
        </div>
      </form>
    </section>
  </main>

  <script>
    const $ = (s, r=document)=>r.querySelector(s);
    const msg = $("#msg");
    const formRequest = $("#formRequest");
    const formConfirm = $("#formConfirm");
    const tabRequest = $("#tabRequest");
    const tabConfirm = $("#tabConfirm");
    const q = new URLSearchParams(location.search);

    function show(type, text){
      msg.className = "msg " + type;
      msg.textContent = text;
      msg.style.display = "block";
    }
    function hideMsg(){ msg.style.display = "none"; }

    function activate(view){
      if (view === "confirm") {
        formRequest.classList.add("hide");
        formConfirm.classList.remove("hide");
        tabRequest.classList.remove("active");
        tabConfirm.classList.add("active");
      } else {
        formConfirm.classList.add("hide");
        formRequest.classList.remove("hide");
        tabConfirm.classList.remove("active");
        tabRequest.classList.add("active");
      }
      hideMsg();
    }

    // Tabs
    tabRequest.addEventListener("click", ()=>activate("request"));
    tabConfirm.addEventListener("click", ()=>activate("confirm"));

    // URL-Parameter auslesen (E-Mail + Token vorbefüllen)
    const sent = q.get("sent");
    const emailQ = q.get("email");
    const tokenQ = q.get("token");
    if (sent === "1") show("ok", "Wenn die E-Mail existiert, wurde ein Link zum Zurücksetzen gesendet.");

    if (emailQ) {
      $("#req_email").value = emailQ;
      $("#conf_email").value = emailQ;
    }
    if (tokenQ) {
      $("#conf_token").value = tokenQ;
      activate("confirm");
    } else {
      activate("request");
    }

    // Formular A: Link zusenden (POST /reset → JSON erwartet)
    formRequest.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideMsg();
      const fd = new FormData(formRequest);
      const body = new URLSearchParams(fd);
      try {
        const res = await fetch("/reset", {
          method:"POST",
          headers:{ "Content-Type":"application/x-www-form-urlencoded" },
          body
        });
        const ct = res.headers.get("content-type")||"";
        if (ct.includes("application/json")) {
          const j = await res.json();
          if (res.ok && j.ok) {
            show("ok", j.message || "E-Mail zum Zurücksetzen wurde gesendet.");
            // Optional: auf die Confirm-Ansicht wechseln, wenn Token via Mail kommt.
            // activate("confirm");
          } else {
            show("err", j.message || "Senden fehlgeschlagen.");
          }
        } else if (res.ok) {
          show("ok", "E-Mail zum Zurücksetzen wurde gesendet.");
        } else {
          show("err", "Senden fehlgeschlagen.");
        }
      } catch (err) {
        show("err", "Netzwerkfehler. Bitte erneut versuchen.");
      }
    });

    // Formular B: Passwort setzen (POST /reset/confirm → JSON erwartet)
    formConfirm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideMsg();

      const email = $("#conf_email").value.trim();
      const token = $("#conf_token").value.trim();
      const first = $("#conf_first").value.trim();
      const last  = $("#conf_last").value.trim();
      const p1 = $("#conf_pass").value;
      const p2 = $("#conf_pass2").value;
      if (!email || !token || !first || !last) {
        show("err", "Bitte alle Pflichtfelder ausfüllen.");
        return;
      }
      if (p1.length < 8) { show("err","Passwort muss mindestens 8 Zeichen haben."); return; }
      if (p1 !== p2)     { show("err","Passwörter stimmen nicht überein."); return; }

      const body = new URLSearchParams({
        email, token, firstName:first, lastName:last, password:p1
      });

      try {
        const res = await fetch("/reset/confirm", {
          method:"POST",
          headers:{ "Content-Type":"application/x-www-form-urlencoded" },
          body
        });
        const ct = res.headers.get("content-type")||"";
        if (ct.includes("application/json")) {
          const j = await res.json();
          if (res.ok && j.ok) {
            show("ok", j.message || "Passwort gesetzt. Du kannst dich jetzt anmelden.");
          } else {
            show("err", j.message || "Zurücksetzen fehlgeschlagen.");
          }
        } else if (res.ok) {
          show("ok", "Passwort gesetzt. Du kannst dich jetzt anmelden.");
        } else {
          show("err", "Zurücksetzen fehlgeschlagen.");
        }
      } catch (err) {
        show("err", "Netzwerkfehler. Bitte erneut versuchen.");
      }
    });
  </script>
</body>
</html>
