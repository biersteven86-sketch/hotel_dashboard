<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Passwort · Hotel-Dashboard</title>
  <meta name="color-scheme" content="light dark">
  <!-- build: reset.html · 2025-09-10 · delay=15s -->

  <!-- Assets (gleich wie login.html) -->
  <link rel="preload" as="image" href="/hotel-dashboard-bg.jpg">
  <link rel="preload" as="image" href="/HD-Logo.png">
  <link rel="preload" as="image" href="/Hotel-Dashboard-Schriftzug.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --page:#06080c; --text:#eef2f8; --muted:#cfd6de;
      --accent:#b71c1c; --accent-2:#7f0000; --accent-link:#fff;
      --panel-r:103; --panel-g:103; --panel-b:103; --panel-alpha:.50; --panel-border:rgba(255,255,255,.10);
      --card-w:440px; --radius:22px;
      --hd:132px; --word-gap:-28px; --title-w:clamp(300px,78%,540px); --title-gap:-20px;
      --ok:#1ecb6b; --warn:#e02724;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-size:16px;line-height:1.45;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      color:var(--text);
      background:var(--page) url("/hotel-dashboard-bg.jpg") center/cover fixed no-repeat;
    }
    .wrap{min-height:100%;display:grid;place-items:center;padding:clamp(18px,4vw,60px)}
    .card{
      position:relative;width:min(var(--card-w),94vw);border-radius:var(--radius);
      background:rgba(var(--panel-r),var(--panel-g),var(--panel-b),var(--panel-alpha));
      backdrop-filter:blur(8px) saturate(120%);-webkit-backdrop-filter:blur(8px) saturate(120%);
      border:1px solid var(--panel-border);
      box-shadow:0 26px 70px rgba(0,0,0,.68),0 1px 0 rgba(255,255,255,.05) inset;
      padding:clamp(18px,2.2vw,24px);padding-top:calc(var(--hd)*.66 + var(--title-gap) + 14px);padding-bottom:8px;overflow:visible;
    }
    .brand-stack{position:absolute;left:50%;top:0;transform:translate(-50%,-51%);display:grid;place-items:center;pointer-events:none;z-index:5;width:min(32vw,520px)}
    .brand-stack .hd{width:var(--hd);height:var(--hd);object-fit:contain;display:block;
      filter:drop-shadow(0 22px 38px rgba(0,0,0,.55)) drop-shadow(0 1px 0 rgba(255,255,255,.08));}
    .brand-stack .wordmark{margin-top:var(--word-gap);width:var(--title-w);height:auto;display:block;
      filter:drop-shadow(0 1px 0 rgba(255,255,255,.10)) drop-shadow(0 16px 26px rgba(0,0,0,.50));}
    .title-spacer{height:var(--title-gap)}
    .content{display:grid;gap:10px}
    label{display:block;font-size:15px;color:#fff;margin:0 0 4px}
    .field{display:grid;grid-template-columns:1fr auto;align-items:center;min-height:48px;padding:0 12px;border-radius:14px;background:transparent;border:1.2px solid rgba(255,255,255,.25);box-shadow:inset 0 1px 0 rgba(255,255,255,.06),0 10px 26px rgba(0,0,0,.40);transition:box-shadow .15s ease,border-color .15s ease}
    .field:focus-within{border-color:rgba(255,255,255,.42);box-shadow:0 0 0 3px rgba(224,40,36,.18),0 14px 34px rgba(0,0,0,.55)}
    .field input{background:transparent;border:0;outline:0;color:#fff;font-size:16px;padding:10px 8px;width:100%;caret-color:#fff}
    .field input::placeholder{color:rgba(255,255,255,.90)}
    .submit{margin-top:12px;border:0;border-radius:14px;padding:12px 26px;font-weight:900;font-size:16px;color:#fff;cursor:pointer;background:linear-gradient(180deg,var(--accent),var(--accent-2));box-shadow:none;transition:transform .08s ease,box-shadow .12s ease}
    .submit:hover{box-shadow:0 8px 18px rgba(0,0,0,.25)} .submit:active{transform:translateY(1px) scale(.997)} .submit:disabled{opacity:.6;cursor:not-allowed;box-shadow:none}
    .row-links{display:flex;gap:12px;font-size:14px;margin-top:8px}
    .row-links a{color:var(--accent-link);text-decoration:none;font-weight:400}
    .row-links a:hover{color:#fff}
    .help{text-align:center;margin:8px 0 10px;font-size:14px;color:var(--muted)}
    .foot{margin-top:15px;padding:12px 6px 6px;border-top:1px solid rgba(255,255,255,.10);text-align:center;color:#e0e5ec;font-size:13px;line-height:1.45}
    .foot small{display:block}
    .note{font-size:13px;color:#cfe4d6;background:rgba(30,203,107,.12);border:1px solid rgba(30,203,107,.4);padding:10px 12px;border-radius:12px;display:none}
    .error{font-size:13px;color:#ffd6d6;background:rgba(224,39,36,.12);border:1px solid rgba(224,39,36,.45);padding:10px 12px;border-radius:12px;display:none}
    .rules{font-size:13px;color:var(--muted);margin-top:6px}
    @media (max-width:560px){
      :root{--card-w:94vw;--hd:116px;--title-w:86%;--word-gap:-24px;--title-gap:12px}
      .brand-stack{transform:translate(-50%,-48%)} .card{padding-top:calc(var(--hd)*.78 + var(--title-gap) + 14px)}
    }
    @media (min-width:561px) and (max-width:900px){
      :root{--card-w:520px;--hd:128px;--title-w:82%;--word-gap:-26px;--title-gap:6px}
      .brand-stack{transform:translate(-50%,-50%)} .card{padding-top:calc(var(--hd)*.72 + var(--title-gap) + 14px)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="group" aria-labelledby="hd-title">
      <div class="brand-stack" aria-hidden="true">
        <img class="hd" src="/HD-Logo.png" alt="HD">
        <img class="wordmark" src="/Hotel-Dashboard-Schriftzug.png" alt="Hotel-Dashboard" id="hd-title">
      </div>
      <div class="title-spacer" aria-hidden="true"></div>

      <div class="content">
        <!-- Modus A: Passwort vergessen (E-Mail anfordern) -->
        <div id="view-forgot" hidden>
          <h2 style="margin:0 0 6px;font-size:20px">Passwort vergessen</h2>
          <p class="help" style="margin-top:0">Gib deine E-Mail ein. Wenn ein Konto existiert, senden wir dir einen Link.</p>

          <div id="msg-forgot" class="note"></div>
          <div id="err-forgot" class="error"></div>

          <form id="form-forgot" novalidate>
            <label for="email">E-Mail</label>
            <div class="field">
              <input id="email" name="email" type="email" placeholder="z. B. name@hotel-dashboard.de" required autocomplete="email" />
            </div>

            <button class="submit" id="btn-forgot" type="submit" disabled>Link zusenden</button>
          </form>

          <div class="row-links" style="margin-top:12px">
            <a href="/login" aria-label="Zur Anmeldung">Zur Anmeldung</a>
          </div>
        </div>

        <!-- Modus B: Neues Passwort setzen (mit Token) -->
        <div id="view-reset" hidden>
          <h2 style="margin:0 0 6px;font-size:20px">Neues Passwort setzen</h2>
          <p class="help" style="margin-top:0">Gib dein neues Passwort ein und bestätige deinen Namen.</p>

          <div id="msg-reset" class="note"></div>
          <div id="err-reset" class="error"></div>

          <form id="form-reset" novalidate>
            <label for="firstname">Vorname (Mitarbeiter)</label>
            <div class="field">
              <input id="firstname" name="firstname" type="text" placeholder="z. B. Max" required autocomplete="given-name" />
            </div>

            <label for="lastname" style="margin-top:8px">Nachname (Mitarbeiter)</label>
            <div class="field">
              <input id="lastname" name="lastname" type="text" placeholder="z. B. Mustermann" required autocomplete="family-name" />
            </div>

            <label for="pw1" style="margin-top:8px">Neues Passwort</label>
            <div class="field">
              <input id="pw1" name="pw1" type="password" placeholder="••••••••••" required autocomplete="new-password" />
            </div>

            <label for="pw2" style="margin-top:8px">Passwort wiederholen</label>
            <div class="field">
              <input id="pw2" name="pw2" type="password" placeholder="••••••••••" required autocomplete="new-password" />
            </div>

            <div class="rules">Mindestens 10 Zeichen, Groß-/Kleinbuchstaben und Zahl oder Sonderzeichen.</div>

            <button class="submit" id="btn-reset" type="submit" disabled>Passwort speichern</button>
          </form>

          <div class="row-links" style="margin-top:12px">
            <a href="/login">Zur Anmeldung</a>
          </div>
        </div>
      </div>

      <div class="foot">
        <small>
          © <span id="y"></span> Hotel-Dashboard<br>
          Powered by MY HOME HOTEL LAMM ROTTWEIL GMBH
        </small>
      </div>
    </div>
  </div>

  <script>
    const REDIRECT_DELAY = 15; // Sekunden
    console.log('reset.html loaded · delay='+REDIRECT_DELAY+'s');

    // Jahr
    document.getElementById('y').textContent = new Date().getFullYear();

    // Modus bestimmen (Token?)
    const params = new URLSearchParams(location.search);
    const token = params.get('token');
    const emailParam = params.get('email');
    const viewForgot = document.getElementById('view-forgot');
    const viewReset  = document.getElementById('view-reset');
    if (token) { viewReset.hidden = false; } else { viewForgot.hidden = false; }

    // ====== FORGOT (E-Mail anfordern) ======
    const email = document.getElementById('email');
    const btnForgot = document.getElementById('btn-forgot');
    const errForgot = document.getElementById('err-forgot');
    const msgForgot = document.getElementById('msg-forgot');

    const updateForgot = ()=>{ btnForgot.disabled = !(email && email.value.trim()); };
    if (email) {
      email.addEventListener('input', updateForgot); updateForgot();

      document.getElementById('form-forgot')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        errForgot.style.display='none'; msgForgot.style.display='none';
        btnForgot.disabled = true;

        try{
          const body = new URLSearchParams({ email: email.value.trim() });
          await fetch('/reset', {
            method:'POST',
            headers:{'Content-Type':'application/x-www-form-urlencoded'},
            body
          });

          let sec = REDIRECT_DELAY;
          msgForgot.innerHTML =
            'Reset-Mail verschickt. Bitte Postfach (und Spam) prüfen. ' +
            'Automatische Rückkehr zur Anmeldung in <b><span id="sec">'+sec+'</span>s</b>.';
          msgForgot.style.display='block';

          const secEl = document.getElementById('sec');
          const t = setInterval(()=>{
            sec--; if (secEl) secEl.textContent = String(sec);
            if (sec <= 0){ clearInterval(t); location.href = "/login"; }
          },1000);
        }catch(err){
          errForgot.textContent = 'Fehler beim Senden. Bitte später erneut versuchen.';
          errForgot.style.display='block';
        }finally{
          btnForgot.disabled = false;
        }
      });
    }

    // ====== RESET (Neues Passwort setzen) ======
    const pw1 = document.getElementById('pw1');
    const pw2 = document.getElementById('pw2');
    const firstname = document.getElementById('firstname');
    const lastname  = document.getElementById('lastname');
    const btnReset = document.getElementById('btn-reset');
    const errReset = document.getElementById('err-reset');
    const msgReset = document.getElementById('msg-reset');

    function strong(pw){
      if(!pw || pw.length < 10) return false;
      const upper = /[A-Z]/.test(pw);
      const lower = /[a-z]/.test(pw);
      const digit = /\d/.test(pw);
      const special = /[^A-Za-z0-9]/.test(pw);
      return (upper && lower && (digit || special));
    }
    function updateReset(){
      const ok =
        pw1 && pw2 && pw1.value.trim() && pw2.value.trim() &&
        pw1.value === pw2.value && strong(pw1.value) &&
        firstname && firstname.value.trim().length >= 2 &&
        lastname  && lastname.value.trim().length >= 2 &&
        token && emailParam;
      if (btnReset) btnReset.disabled = !ok;
    }
    [pw1,pw2,firstname,lastname].forEach(el=> el && el.addEventListener('input', updateReset));
    updateReset();

    document.getElementById('form-reset')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      errReset.style.display='none'; msgReset.style.display='none';
      btnReset.disabled = true;

      try{
        // optional: Token vorab validieren (liefert nur 200/400)
        const v = await fetch('/reset/validate?token='+encodeURIComponent(token)+'&email='+encodeURIComponent(emailParam));
        if (!v.ok) throw new Error('Token ungültig oder abgelaufen');

        const body = new URLSearchParams({
          token, email: emailParam,
          password: pw1.value,
          firstname: firstname.value.trim(),
          lastname: lastname.value.trim()
        });
        const res = await fetch('/reset/confirm', {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body
        });
        if(!res.ok){
          const txt = await res.text();
          throw new Error(txt || 'Fehler beim Speichern');
        }

        msgReset.textContent = 'Dein Passwort wurde aktualisiert. Du kannst dich jetzt anmelden.';
        msgReset.style.display='block';
        setTimeout(()=>{ location.href = '/login?reset=1'; }, 1400);
      }catch(err){
        errReset.textContent = err && err.message ? err.message : 'Fehler beim Speichern. Bitte später erneut versuchen.';
        errReset.style.display='block';
      }finally{
        btnReset.disabled = false;
      }
    });
  </script>
</body>
</html>
